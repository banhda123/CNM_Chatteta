<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zalo Clone Chat</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .user-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-online {
      background-color: #44b700;
    }

    .status-offline {
      background-color: #bdbdbd;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: #f0f2f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    #auth {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background: #0084ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0073e6;
    }

    #chat {
      display: none;
      height: calc(100vh - 40px);
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
    }

    .chat-header {
      padding: 15px;
      background: #0084ff;
      color: white;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .messages-container {
      height: calc(100% - 130px);
      overflow-y: auto;
      padding: 20px;
    }

    #messages {
      list-style: none;
    }

    .message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 15px;
    max-width: 70%;
    clear: both;
    position: relative;
  }

  .message.sent {
    float: right;
    background-color: #0084ff;
    color: white;
    margin-left: 30%;
    border-bottom-right-radius: 5px;
  }

  .message.received {
    float: left;
    background-color: #e4e6eb;
    color: black;
    margin-right: 30%;
    border-bottom-left-radius: 5px;
  }

  .message-sender {
    font-size: 12px;
    margin-bottom: 4px;
    opacity: 0.8;
  }

  .message-content {
    font-size: 14px;
    word-wrap: break-word;
  }

  .message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
    text-align: right;
  }

  .messages {
    list-style: none;
    padding: 0;
  }

  .clearfix::after {
    content: "";
    clear: both;
    display: table;
  }
    .chat-input {
      padding: 15px;
      background: #f0f2f5;
      border-radius: 0 0 8px 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-input input {
      flex: 1;
    }

    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    
    .message-image {
      max-width: 300px;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      object-fit: contain;
    }
    
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      display: none;
      z-index: 100;
      width: 250px;
      height: 200px;
      overflow-y: auto;
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .emoji-item {
      font-size: 24px;
      cursor: pointer;
      text-align: center;
      padding: 5px;
      border-radius: 4px;
    }
    
    .emoji-item:hover {
      background-color: #f0f2f5;
    }
    
    .attachment-btn, .emoji-btn {
      background: none;
      border: none;
      color: #0084ff;
      font-size: 20px;
      cursor: pointer;
      padding: 5px 10px;
    }
    
    .file-input {
      display: none;
    }
    
    /* Styles cho sidebar v√† t√≠nh nƒÉng b·∫°n b√® */
    .sidebar {
      width: 300px;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      background-color: #f5f7fa;
    }
    
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 15px;
      background: #0084ff;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .search-container {
      padding: 10px;
      display: flex;
      gap: 5px;
    }
    
    .search-container input {
      flex: 1;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 10px;
      cursor: pointer;
      color: #555;
    }
    
    .tab-btn.active {
      border-bottom: 2px solid #0084ff;
      color: #0084ff;
    }
    
    .tab-content {
      display: none;
      padding: 10px;
      flex: 1;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .user-list {
      list-style: none;
      padding: 0;
    }
    
    .user-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #555;
    }
    
    .user-actions {
      display: flex;
      gap: 5px;
    }
    
    .user-actions button {
      padding: 5px 10px;
      font-size: 12px;
    }
    
    .notification-badge {
      background-color: #ff3b30;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .loading-message, .empty-message, .error-message {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      color: #666;
      font-style: italic;
    }
    .error-message {
      color: #e74c3c;
    }
    .date-separator {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      color: #666;
      font-size: 12px;
      position: relative;
    }
    .date-separator:before, .date-separator:after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30%;
      height: 1px;
      background-color: #ddd;
    }
    .date-separator:before {
      left: 0;
    }
    .date-separator:after {
      right: 0;
    }
    .message-sender {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
      font-weight: bold;
    }
    .sent .message-sender {
      color: #3498db;
    }
    .received .message-sender {
      color: #2ecc71;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .user-info .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .header-actions {
        display: flex;
        gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth">
      <div id="loginForm">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <div class="form-group">
          <input id="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" />
          <input id="password" type="password" placeholder="M·∫≠t kh·∫©u" />
          <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        </div>
      </div>
      
      <div id="registerForm">
        <h2>ƒêƒÉng k√Ω</h2>
        <div class="form-group">
          <input id="regUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" />
          <input id="regPassword" type="password" placeholder="M·∫≠t kh·∫©u" />
          <input id="regFullname" placeholder="H·ªç t√™n" />
          <button onclick="register()">ƒêƒÉng k√Ω</button>
        </div>
      </div>
    </div>

    <div id="chat">
      <!-- Sidebar cho danh s√°ch b·∫°n b√® v√† l·ªùi m·ªùi k·∫øt b·∫°n -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div>
            <span class="user-status" id="userStatus"></span>
            <span id="userInfo"></span>
          </div>
          <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
        
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..." />
          <button onclick="searchUsers()">T√¨m</button>
        </div>
        
        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('friendsTab')">B·∫°n b√®</button>
          <button class="tab-btn" onclick="showTab('requestsTab')">L·ªùi m·ªùi</button>
          <button class="tab-btn" onclick="showTab('searchTab')">K·∫øt qu·∫£</button>
        </div>
        
        <div id="friendsTab" class="tab-content active">
          <h3>Danh s√°ch b·∫°n b√®</h3>
          <ul id="friendsList" class="user-list"></ul>
        </div>
        
        <div id="requestsTab" class="tab-content">
          <h3>L·ªùi m·ªùi k·∫øt b·∫°n</h3>
          <ul id="requestsList" class="user-list"></ul>
        </div>
        
        <div id="searchTab" class="tab-content">
          <h3>K·∫øt qu·∫£ t√¨m ki·∫øm</h3>
          <ul id="searchResults" class="user-list"></ul>
        </div>
      </div>
      
      <!-- Khu v·ª±c chat ch√≠nh -->
      <div class="chat-main">
        <div class="header">
            <div class="user-info">
                <img id="userAvatar" src="" alt="Avatar" class="avatar">
                <span id="username"></span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.location.href='/profile'">H·ªì s∆°</button>
                <button class="btn btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        <div class="chat-header">
          <h2 id="chatHeader">Chat</h2>
        </div>
        
        <div class="messages-container">
          <ul id="messages"></ul>
        </div>
        
        <div class="chat-input">
          <button class="emoji-btn" onclick="toggleEmojiPicker()">üòä</button>
          <label for="fileInput" class="attachment-btn">üìé</label>
          <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)" />
          <input id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleKeyPress(event)"/>
          <button onclick="sendMessage()">G·ª≠i</button>
          
          <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // L·∫•y token t·ª´ localStorage
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/';
    }

    // Load th√¥ng tin ng∆∞·ªùi d√πng
    async function loadUserInfo() {
        try {
            const response = await fetch('/api/users/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('username').textContent = data.user.username;
                if (data.user.avatar) {
                    document.getElementById('userAvatar').src = data.user.avatar;
                }
            }
        } catch (error) {
            console.error('L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:', error);
        }
    }

    // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/';
    }

    // Load th√¥ng tin khi trang t·∫£i xong
    loadUserInfo();

    // Ki·ªÉm tra ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (token) {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('chat').style.display = 'flex';
        document.getElementById('userInfo').textContent = localStorage.getItem('username') || 'Ng∆∞·ªùi d√πng';
        connectSocket();
        loadFriends();
        loadFriendRequests();
      } else {
        document.getElementById('auth').style.display = 'block';
        document.getElementById('chat').style.display = 'none';
      }
    }

    // K·∫øt n·ªëi Socket.IO
    function connectSocket() {
      const token = localStorage.getItem('token');
      if (!token) return;

      // N·∫øu ƒë√£ c√≥ socket, ng·∫Øt k·∫øt n·ªëi tr∆∞·ªõc khi t·∫°o m·ªõi
      if (window.socket) {
        console.log('Ng·∫Øt k·∫øt n·ªëi socket c≈© tr∆∞·ªõc khi t·∫°o m·ªõi');
        window.socket.disconnect();
      }

      const socket = window.socket = io('http://localhost:5000', {
        auth: { token },
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        timeout: 10000 // TƒÉng timeout l√™n 10 gi√¢y
      });

      // L·∫Øng nghe tin nh·∫Øn c≈©
      socket.on('load-messages', (messages) => {
        console.log('Nh·∫≠n tin nh·∫Øn c≈©:', messages);
        const messagesList = document.getElementById('messages');
        messagesList.innerHTML = ''; // X√≥a tin nh·∫Øn c≈©
        
        // X√≥a th√¥ng b√°o ƒëang t·∫£i n·∫øu c√≥
        document.querySelector('.loading-message')?.remove();
        
        if (!messages) {
          console.error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu tin nh·∫Øn');
          const errorMessage = document.createElement('li');
          errorMessage.className = 'error-message';
          errorMessage.textContent = 'Kh√¥ng th·ªÉ t·∫£i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i sau.';
          messagesList.appendChild(errorMessage);
          return;
        }
        
        if (Array.isArray(messages)) {
          if (messages.length === 0) {
            console.log('Kh√¥ng c√≥ tin nh·∫Øn c≈©');
            const emptyMessage = document.createElement('li');
            emptyMessage.className = 'empty-message';
            emptyMessage.textContent = 'Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán!';
            messagesList.appendChild(emptyMessage);
          } else {
            console.log(`Hi·ªÉn th·ªã ${messages.length} tin nh·∫Øn c≈©`);
            
            // Th√™m ph√¢n t√°ch ng√†y n·∫øu c·∫ßn
            let currentDate = null;
            
            messages.forEach((message, index) => {
              console.log(`Tin nh·∫Øn ${index + 1}:`, message);
              
              // Ki·ªÉm tra v√† th√™m ph√¢n t√°ch ng√†y n·∫øu c·∫ßn
              if (message.created_at) {
                const messageDate = new Date(message.created_at).toLocaleDateString();
                if (messageDate !== currentDate) {
                  currentDate = messageDate;
                  const dateDiv = document.createElement('div');
                  dateDiv.className = 'date-separator';
                  dateDiv.textContent = currentDate;
                  messagesList.appendChild(dateDiv);
                }
              }
              
              // Th√™m tin nh·∫Øn v√†o giao di·ªán
              addMessage(message);
            });
          }
          
          // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
          setTimeout(() => {
            const container = document.querySelector('.messages-container');
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          }, 100);
        } else {
          console.error('D·ªØ li·ªáu tin nh·∫Øn kh√¥ng ph·∫£i l√† m·∫£ng:', messages);
          const errorMessage = document.createElement('li');
          errorMessage.className = 'error-message';
          errorMessage.textContent = 'ƒê·ªãnh d·∫°ng tin nh·∫Øn kh√¥ng h·ª£p l·ªá.';
          messagesList.appendChild(errorMessage);
        }
      });

      // L·∫Øng nghe tin nh·∫Øn m·ªõi
      socket.on('new-message', (message) => {
        console.log('Nh·∫≠n tin nh·∫Øn m·ªõi:', message);
        
        // X√≥a th√¥ng b√°o "Ch∆∞a c√≥ tin nh·∫Øn n√†o" n·∫øu c√≥
        const emptyMessage = document.querySelector('.empty-message');
        if (emptyMessage) {
          emptyMessage.remove();
        }
        
        addMessage(message);
        
        // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
        setTimeout(() => {
          const container = document.querySelector('.messages-container');
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        }, 100);
      });

      socket.on('connect', () => {
        console.log('ƒê√£ k·∫øt n·ªëi socket');
        socket.emit('update-status', { status: 'online' });
        
        // N·∫øu ƒë√£ c√≥ ng∆∞·ªùi nh·∫≠n, tham gia v√†o cu·ªôc tr√≤ chuy·ªán v·ªõi h·ªç
        if (currentRecipient.id) {
          console.log('Tham gia cu·ªôc tr√≤ chuy·ªán v·ªõi:', currentRecipient.id);
          socket.emit('join-conversation', currentRecipient.id);
        }
      });

      socket.on('disconnect', () => {
        console.log('M·∫•t k·∫øt n·ªëi socket');
      });

      socket.on('status-update', (data) => {
        console.log('C·∫≠p nh·∫≠t tr·∫°ng th√°i:', data);
        const statusElement = document.getElementById('userStatus');
        if (statusElement) {
          statusElement.className = `user-status status-${data.status}`;
        }
      });
      
      // Th√™m s·ª± ki·ªán l·∫Øng nghe l·ªói
      socket.on('connect_error', (error) => {
        console.error('L·ªói k·∫øt n·ªëi socket:', error);
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói n·∫øu ƒëang trong cu·ªôc tr√≤ chuy·ªán
        if (currentRecipient.id) {
          const loadingMessage = document.querySelector('.loading-message');
          if (loadingMessage) {
            loadingMessage.remove();
            
            const errorMessage = document.createElement('li');
            errorMessage.className = 'error-message';
            errorMessage.textContent = 'L·ªói k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i sau.';
            document.getElementById('messages').appendChild(errorMessage);
          }
        }
      });
      
      socket.on('error', (error) => {
        console.error('L·ªói socket:', error);
      });
      
      // L·∫Øng nghe ph·∫£n h·ªìi t·ª´ s·ª± ki·ªán join-conversation
      socket.on('joined-conversation', (data) => {
        console.log('ƒê√£ tham gia cu·ªôc tr√≤ chuy·ªán:', data);
      });
    }

    // Th√™m tin nh·∫Øn v√†o giao di·ªán
    function addMessage(message, isSent = null) {
      try {
        console.log('Th√™m tin nh·∫Øn v√†o giao di·ªán:', message);
        
        if (!message || !message.content) {
          console.error('Tin nh·∫Øn kh√¥ng h·ª£p l·ªá:', message);
          return;
        }
        
        const currentUserId = localStorage.getItem('userId');
        console.log('ID ng∆∞·ªùi d√πng hi·ªán t·∫°i:', currentUserId);
        console.log('ID ng∆∞·ªùi g·ª≠i tin nh·∫Øn:', message.sender_id);
        
        // N·∫øu isSent kh√¥ng ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh, t√≠nh to√°n d·ª±a tr√™n sender_id
        if (isSent === null && message.sender_id) {
          isSent = message.sender_id.toString() === currentUserId;
        }
        
        console.log('Tin nh·∫Øn n√†y do ng∆∞·ªùi d√πng hi·ªán t·∫°i g·ª≠i?', isSent);
        
        const messages = document.getElementById('messages');
        const li = document.createElement('li');
        li.className = `message ${isSent ? 'sent' : 'received'} clearfix`;
        
        // Th√™m th√¥ng tin ng∆∞·ªùi g·ª≠i cho t·∫•t c·∫£ tin nh·∫Øn
        const senderDiv = document.createElement('div');
        senderDiv.className = 'message-sender';
        
        if (isSent) {
          senderDiv.textContent = 'B·∫°n';
          senderDiv.style.textAlign = 'right';
        } else {
          senderDiv.textContent = message.sender_name || currentRecipient.name || 'Ng∆∞·ªùi d√πng';
        }
        
        li.appendChild(senderDiv);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        // X·ª≠ l√Ω hi·ªÉn th·ªã tin nh·∫Øn theo lo·∫°i
        if (message.type === 'image') {
          // Hi·ªÉn th·ªã ·∫£nh
          const img = document.createElement('img');
          img.src = message.content;
          img.className = 'message-image';
          img.alt = 'H√¨nh ·∫£nh';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/200x150?text=L·ªói+t·∫£i+·∫£nh';
          };
          contentDiv.appendChild(img);
        } else if (message.type === 'emoji') {
          // Hi·ªÉn th·ªã emoji
          contentDiv.textContent = message.content;
          contentDiv.style.fontSize = '24px';
        } else {
          // Hi·ªÉn th·ªã tin nh·∫Øn vƒÉn b·∫£n th√¥ng th∆∞·ªùng
          contentDiv.textContent = message.content;
        }
        
        li.appendChild(contentDiv);
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        
        // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p kh√¥ng c√≥ created_at
        if (message.created_at) {
          const messageTime = new Date(message.created_at);
          timeDiv.textContent = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
          timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        li.appendChild(timeDiv);
        
        // Th√™m ID tin nh·∫Øn ƒë·ªÉ d·ªÖ debug
        if (message.id) {
          li.setAttribute('data-message-id', message.id);
        }
        
        messages.appendChild(li);
      } catch (error) {
        console.error('L·ªói hi·ªÉn th·ªã tin nh·∫Øn:', error, message);
      }
    }

    // Bi·∫øn l∆∞u tr·ªØ file ·∫£nh ƒë√£ ch·ªçn
    let selectedFile = null;
    
    // Bi·∫øn l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi nh·∫≠n tin nh·∫Øn hi·ªán t·∫°i
    let currentRecipient = {
      id: null,
      name: null
    };
    
    // G·ª≠i tin nh·∫Øn
    function sendMessage() {
      try {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        // Ki·ªÉm tra xem ƒë√£ ch·ªçn ng∆∞·ªùi nh·∫≠n ch∆∞a
        if (!currentRecipient.id) {
          alert('Vui l√≤ng ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªÉ nh·∫Øn tin');
          return;
        }
        
        // ƒê·∫£m b·∫£o ID ng∆∞·ªùi nh·∫≠n l√† s·ªë
        const recipientId = parseInt(currentRecipient.id, 10);
        if (isNaN(recipientId)) {
          console.error('ID ng∆∞·ªùi nh·∫≠n kh√¥ng h·ª£p l·ªá:', currentRecipient.id);
          return;
        }
        
        // N·∫øu c√≥ file ·∫£nh ƒë∆∞·ª£c ch·ªçn, ∆∞u ti√™n g·ª≠i ·∫£nh
        if (selectedFile && window.socket) {
          uploadAndSendImage(selectedFile);
          selectedFile = null;
          return;
        }
        
        // N·∫øu kh√¥ng c√≥ ·∫£nh, g·ª≠i tin nh·∫Øn vƒÉn b·∫£n
        if (message && window.socket) {
          // T·∫°o ƒë·ªëi t∆∞·ª£ng tin nh·∫Øn t·∫°m th·ªùi ƒë·ªÉ hi·ªÉn th·ªã ngay
          const tempMessage = {
            content: message,
            type: 'text',
            sender_id: localStorage.getItem('userId'),
            sender_name: localStorage.getItem('username'),
            created_at: new Date().toISOString()
          };
          
          // Hi·ªÉn th·ªã tin nh·∫Øn ngay l·∫≠p t·ª©c tr√™n giao di·ªán
          addMessage(tempMessage, true);
          
          // G·ª≠i tin nh·∫Øn ƒë·∫øn server
          window.socket.emit('send-message', {
            conversationId: recipientId,
            content: message,
            type: 'text'
          });
          
          console.log('ƒê√£ g·ª≠i tin nh·∫Øn:', {
            conversationId: recipientId,
            content: message,
            type: 'text'
          });
          
          // X√≥a n·ªôi dung input
          input.value = '';
        }
      } catch (error) {
        console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', error);
      }
    }
    
    // X·ª≠ l√Ω khi ch·ªçn file
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Ki·ªÉm tra xem file c√≥ ph·∫£i l√† ·∫£nh kh√¥ng
      if (!file.type.startsWith('image/')) {
        alert('Vui l√≤ng ch·ªçn file ·∫£nh');
        return;
      }
      
      // L∆∞u file ƒë√£ ch·ªçn
      selectedFile = file;
      
      // Th√¥ng b√°o cho ng∆∞·ªùi d√πng bi·∫øt ƒë√£ ch·ªçn ·∫£nh
      const input = document.getElementById('messageInput');
      input.placeholder = `ƒê√£ ch·ªçn ·∫£nh: ${file.name}. Nh·∫•n G·ª≠i ƒë·ªÉ g·ª≠i ·∫£nh.`;
    }
    
    // Upload v√† g·ª≠i ·∫£nh
    async function uploadAndSendImage(file) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success && data.url) {
          // G·ª≠i tin nh·∫Øn v·ªõi ƒë∆∞·ªùng d·∫´n ·∫£nh
          window.socket.emit('send-message', {
            conversationId: currentRecipient.id,
            content: data.url,
            type: 'image'
          });
          
          // Reset placeholder
          const input = document.getElementById('messageInput');
          input.placeholder = 'Nh·∫≠p tin nh·∫Øn...';
          
          // Reset file input
          document.getElementById('fileInput').value = '';
        } else {
          alert('L·ªói khi t·∫£i l√™n ·∫£nh: ' + (data.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
        }
      } catch (error) {
        console.error('L·ªói khi t·∫£i l√™n ·∫£nh:', error);
        alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server');
      }
    }
    
    // Hi·ªÉn th·ªã/·∫©n emoji picker
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      if (emojiPicker.style.display === 'block') {
        emojiPicker.style.display = 'none';
      } else {
        emojiPicker.style.display = 'block';
        loadEmojis();
      }
    }
    
    // Load danh s√°ch emoji
    function loadEmojis() {
      const emojiGrid = document.getElementById('emojiGrid');
      if (emojiGrid.children.length > 0) return; // ƒê√£ load r·ªìi
      
      // Danh s√°ch emoji ph·ªï bi·∫øn
      const emojis = [
        'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá',
        'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö',
        'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©',
        'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ',
        'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø',
        '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'üíî', '‚ù£Ô∏è', 'üíï',
        'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', 'üëç', 'üëé', 'üëå'
      ];
      
      // T·∫°o c√°c ph·∫ßn t·ª≠ emoji
      emojis.forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.onclick = () => sendEmoji(emoji);
        emojiGrid.appendChild(emojiItem);
      });
    }
    
    // G·ª≠i emoji
    function sendEmoji(emoji) {
      if (window.socket) {
        // Ki·ªÉm tra xem ƒë√£ ch·ªçn ng∆∞·ªùi nh·∫≠n ch∆∞a
        if (!currentRecipient.id) {
          alert('Vui l√≤ng ch·ªçn m·ªôt ng∆∞·ªùi b·∫°n ƒë·ªÉ nh·∫Øn tin');
          return;
        }
        
        // T·∫°o ƒë·ªëi t∆∞·ª£ng tin nh·∫Øn t·∫°m th·ªùi ƒë·ªÉ hi·ªÉn th·ªã ngay
        const tempMessage = {
          content: emoji,
          type: 'emoji',
          sender_id: localStorage.getItem('userId'),
          sender_name: localStorage.getItem('username'),
          created_at: new Date().toISOString()
        };
        
        // Hi·ªÉn th·ªã emoji ngay l·∫≠p t·ª©c tr√™n giao di·ªán
        addMessage(tempMessage, true);
        
        // G·ª≠i emoji ƒë·∫øn server
        window.socket.emit('send-message', {
          conversationId: currentRecipient.id,
          content: emoji,
          type: 'emoji'
        });
        
        console.log('ƒê√£ g·ª≠i emoji:', {
          conversationId: currentRecipient.id,
          content: emoji,
          type: 'emoji'
        });
        
        // ·∫®n emoji picker
        document.getElementById('emojiPicker').style.display = 'none';
      }
    }

    // X·ª≠ l√Ω ph√≠m Enter
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ƒêƒÉng nh·∫≠p
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('http://localhost:5000/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('username', data.user.username);
          localStorage.setItem('userId', data.user.id);
          alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
          checkAuth();
        } else {
          alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + data.message);
        }
      } catch (error) {
        console.error('L·ªói ƒëƒÉng nh·∫≠p:', error);
        alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server');
      }
    }

    // ƒêƒÉng k√Ω
    async function register() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const fullname = document.getElementById('regFullname').value;
      
      if (!username || !password || !fullname) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin ƒëƒÉng k√Ω');
        return;
      }
      
      try {
        const response = await fetch('http://localhost:5000/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password, fullname })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.');
          document.getElementById('username').value = username;
        } else {
          alert('ƒêƒÉng k√Ω th·∫•t b·∫°i: ' + (data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
        }
      } catch (error) {
        console.error('L·ªói ƒëƒÉng k√Ω:', error);
        alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server');
      }
    }

    // B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi b·∫°n b√®
    function startChat(friendId, friendName) {
      try {
        console.log('B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán v·ªõi b·∫°n b√®:', { friendId, friendName });
        
        // ƒê·∫£m b·∫£o friendId l√† s·ªë
        friendId = parseInt(friendId, 10);
        if (isNaN(friendId)) {
          console.error('ID b·∫°n b√® kh√¥ng h·ª£p l·ªá:', friendId);
          return;
        }
        
        // L∆∞u th√¥ng tin ng∆∞·ªùi nh·∫≠n hi·ªán t·∫°i
        currentRecipient.id = friendId;
        
        // N·∫øu kh√¥ng c√≥ t√™n, l·∫•y t·ª´ danh s√°ch b·∫°n b√®
        if (!friendName) {
          const friendsList = document.querySelectorAll('#friendsList .user-item');
          for (const item of friendsList) {
            const id = item.getAttribute('data-id');
            if (id === friendId.toString()) {
              friendName = item.querySelector('.user-info div:first-child').textContent;
              break;
            }
          }
        }
        
        currentRecipient.name = friendName || 'Ng∆∞·ªùi d√πng';
        console.log('Th√¥ng tin ng∆∞·ªùi nh·∫≠n hi·ªán t·∫°i:', currentRecipient);
        
        // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ chat
        document.querySelector('.chat-header h2').textContent = `Chat v·ªõi ${currentRecipient.name}`;
        
        // X√≥a tin nh·∫Øn c≈© trong khung chat
        document.getElementById('messages').innerHTML = '';
        
        // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang t·∫£i
        const loadingMessage = document.createElement('li');
        loadingMessage.className = 'loading-message';
        loadingMessage.textContent = 'ƒêang t·∫£i tin nh·∫Øn...';
        document.getElementById('messages').appendChild(loadingMessage);
        
        // Hi·ªÉn th·ªã khung chat n·∫øu ƒëang ·∫©n
        document.querySelector('.chat-container').style.display = 'flex';
        
        // Tham gia v√†o cu·ªôc tr√≤ chuy·ªán
        if (window.socket && window.socket.connected) {
          console.log('Socket ƒë√£ k·∫øt n·ªëi, tham gia cu·ªôc tr√≤ chuy·ªán v·ªõi:', friendId);
          window.socket.emit('join-conversation', friendId);
        } else {
          console.log('Socket ch∆∞a k·∫øt n·ªëi, th·ª≠ k·∫øt n·ªëi l·∫°i');
          // Th·ª≠ k·∫øt n·ªëi l·∫°i
          connectSocket();
          
          // ƒê·∫∑t timeout d√†i h∆°n ƒë·ªÉ ƒë·∫£m b·∫£o socket c√≥ ƒë·ªß th·ªùi gian k·∫øt n·ªëi
          setTimeout(() => {
            if (window.socket && window.socket.connected) {
              console.log('ƒê√£ k·∫øt n·ªëi l·∫°i socket, tham gia cu·ªôc tr√≤ chuy·ªán v·ªõi:', friendId);
              window.socket.emit('join-conversation', friendId);
            } else {
              console.error('Kh√¥ng th·ªÉ k·∫øt n·ªëi socket sau khi th·ª≠ l·∫°i');
              // X√≥a th√¥ng b√°o ƒëang t·∫£i
              document.querySelector('.loading-message')?.remove();
              
              // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
              const errorMessage = document.createElement('li');
              errorMessage.className = 'error-message';
              errorMessage.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i sau.';
              document.getElementById('messages').appendChild(errorMessage);
            }
          }, 3000); // TƒÉng th·ªùi gian ch·ªù l√™n 3 gi√¢y
        }
        
        // Focus v√†o √¥ nh·∫≠p tin nh·∫Øn
        document.getElementById('messageInput').focus();
      } catch (error) {
        console.error('L·ªói khi b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán:', error);
      }
    }
    
    // Th√™m x·ª≠ l√Ω t√¨m ki·∫øm khi nh·∫•n Enter
    document.getElementById('searchInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        searchUsers();
      }
    });
    
    // L·∫•y danh s√°ch b·∫°n b√®
    async function loadFriends() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/friends/list', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const friendsList = document.getElementById('friendsList');
          friendsList.innerHTML = '';
          
          if (data.friends.length === 0) {
            friendsList.innerHTML = '<li class="user-item">B·∫°n ch∆∞a c√≥ b·∫°n b√® n√†o</li>';
            return;
          }
          
          // S·ª≠ d·ª•ng Set ƒë·ªÉ lo·∫°i b·ªè tr√πng l·∫∑p d·ª±a tr√™n ID
          const uniqueFriends = Array.from(
            new Map(data.friends.map(friend => [friend.id, friend])).values()
          );
          
          console.log('Danh s√°ch b·∫°n b√® (ƒë√£ lo·∫°i b·ªè tr√πng l·∫∑p):', uniqueFriends);
          
          uniqueFriends.forEach(friend => {
            const li = document.createElement('li');
            li.className = 'user-item';
            li.setAttribute('data-id', friend.id);
            
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            avatar.textContent = friend.fullname.charAt(0).toUpperCase();
            
            const nameStatus = document.createElement('div');
            const name = document.createElement('div');
            name.textContent = friend.fullname;
            
            const status = document.createElement('div');
            status.innerHTML = `<span class="user-status status-${friend.status || 'offline'}"></span> ${friend.status || 'offline'}`;
            
            nameStatus.appendChild(name);
            nameStatus.appendChild(status);
            
            userInfo.appendChild(avatar);
            userInfo.appendChild(nameStatus);
            
            const actions = document.createElement('div');
            actions.className = 'user-actions';
            
            const chatBtn = document.createElement('button');
            chatBtn.textContent = 'Nh·∫Øn tin';
            chatBtn.onclick = () => startChat(friend.id, friend.fullname);
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'X√≥a b·∫°n';
            removeBtn.onclick = () => removeFriend(friend.id);
            
            actions.appendChild(chatBtn);
            actions.appendChild(removeBtn);
            
            li.appendChild(userInfo);
            li.appendChild(actions);
            
            friendsList.appendChild(li);
          });
        } else {
          console.error('L·ªói l·∫•y danh s√°ch b·∫°n b√®:', data.message);
        }
      } catch (error) {
        console.error('L·ªói l·∫•y danh s√°ch b·∫°n b√®:', error);
      }
    }
    
    // L·∫•y danh s√°ch l·ªùi m·ªùi k·∫øt b·∫°n
    async function loadFriendRequests() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/friends/requests', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const requestsList = document.getElementById('requestsList');
          requestsList.innerHTML = '';
          
          // Hi·ªÉn th·ªã l·ªùi m·ªùi ƒë√£ nh·∫≠n
          if (data.received.length > 0) {
            const receivedHeader = document.createElement('li');
            receivedHeader.className = 'request-header';
            receivedHeader.textContent = 'L·ªùi m·ªùi ƒë√£ nh·∫≠n';
            requestsList.appendChild(receivedHeader);
            
            data.received.forEach(request => {
              const li = document.createElement('li');
              li.className = 'user-item';
              
              const userInfo = document.createElement('div');
              userInfo.className = 'user-info';
              
              const avatar = document.createElement('div');
              avatar.className = 'user-avatar';
              avatar.textContent = request.fullname.charAt(0).toUpperCase();
              
              const nameTime = document.createElement('div');
              const name = document.createElement('div');
              name.textContent = request.fullname;
              
              const time = document.createElement('div');
              time.className = 'request-time';
              time.textContent = new Date(request.created_at).toLocaleString();
              
              nameTime.appendChild(name);
              nameTime.appendChild(time);
              
              userInfo.appendChild(avatar);
              userInfo.appendChild(nameTime);
              
              const actions = document.createElement('div');
              actions.className = 'user-actions';
              
              const acceptBtn = document.createElement('button');
              acceptBtn.textContent = 'Ch·∫•p nh·∫≠n';
              acceptBtn.onclick = () => acceptFriendRequest(request.id);
              
              const rejectBtn = document.createElement('button');
              rejectBtn.textContent = 'T·ª´ ch·ªëi';
              rejectBtn.onclick = () => rejectFriendRequest(request.id);
              
              actions.appendChild(acceptBtn);
              actions.appendChild(rejectBtn);
              
              li.appendChild(userInfo);
              li.appendChild(actions);
              
              requestsList.appendChild(li);
            });
          }
          
          // Hi·ªÉn th·ªã l·ªùi m·ªùi ƒë√£ g·ª≠i
          if (data.sent.length > 0) {
            const sentHeader = document.createElement('li');
            sentHeader.className = 'request-header';
            sentHeader.textContent = 'L·ªùi m·ªùi ƒë√£ g·ª≠i';
            requestsList.appendChild(sentHeader);
            
            data.sent.forEach(request => {
              const li = document.createElement('li');
              li.className = 'user-item';
              
              const userInfo = document.createElement('div');
              userInfo.className = 'user-info';
              
              const avatar = document.createElement('div');
              avatar.className = 'user-avatar';
              avatar.textContent = request.fullname.charAt(0).toUpperCase();
              
              const nameTime = document.createElement('div');
              const name = document.createElement('div');
              name.textContent = request.fullname;
              
              const time = document.createElement('div');
              time.className = 'request-time';
              time.textContent = new Date(request.created_at).toLocaleString();
              
              nameTime.appendChild(name);
              nameTime.appendChild(time);
              
              userInfo.appendChild(avatar);
              userInfo.appendChild(nameTime);
              
              const status = document.createElement('div');
              status.className = 'request-status';
              status.textContent = 'ƒêang ch·ªù';
              
              li.appendChild(userInfo);
              li.appendChild(status);
              
              requestsList.appendChild(li);
            });
          }
          
          if (data.received.length === 0 && data.sent.length === 0) {
            requestsList.innerHTML = '<li class="user-item">Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n n√†o</li>';
          }
        } else {
          console.error('L·ªói l·∫•y danh s√°ch l·ªùi m·ªùi k·∫øt b·∫°n:', data.message);
        }
      } catch (error) {
        console.error('L·ªói l·∫•y danh s√°ch l·ªùi m·ªùi k·∫øt b·∫°n:', error);
      }
    }
    
    // T√¨m ki·∫øm ng∆∞·ªùi d√πng
    async function searchUsers() {
      try {
        const keyword = document.getElementById('searchInput').value.trim();
        
        if (keyword.length < 2) {
          alert('Vui l√≤ng nh·∫≠p √≠t nh·∫•t 2 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm');
          return;
        }
        
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/search?keyword=${encodeURIComponent(keyword)}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const searchResults = document.getElementById('searchResults');
          searchResults.innerHTML = '';
          
          if (data.users.length === 0) {
            searchResults.innerHTML = '<li class="user-item">Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</li>';
            return;
          }
          
          data.users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-item';
            li.setAttribute('data-id', user.id);
            
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            avatar.textContent = user.fullname.charAt(0).toUpperCase();
            
            const nameStatus = document.createElement('div');
            const name = document.createElement('div');
            name.textContent = user.fullname;
            
            const status = document.createElement('div');
            status.innerHTML = `<span class="user-status status-${user.status || 'offline'}"></span> ${user.status || 'offline'}`;
            
            nameStatus.appendChild(name);
            nameStatus.appendChild(status);
            
            userInfo.appendChild(avatar);
            userInfo.appendChild(nameStatus);
            
            const actions = document.createElement('div');
            actions.className = 'user-actions';
            
            // Hi·ªÉn th·ªã n√∫t t∆∞∆°ng ·ª©ng v·ªõi m·ªëi quan h·ªá
            if (user.relationship === 'friend') {
              const chatBtn = document.createElement('button');
              chatBtn.textContent = 'Nh·∫Øn tin';
              chatBtn.onclick = () => startChat(user.id, user.fullname);
              
              const removeBtn = document.createElement('button');
              removeBtn.textContent = 'X√≥a b·∫°n';
              removeBtn.onclick = () => removeFriend(user.id);
              
              actions.appendChild(chatBtn);
              actions.appendChild(removeBtn);
            } else if (user.relationship === 'sent_request') {
              const pendingBtn = document.createElement('button');
              pendingBtn.textContent = 'ƒê√£ g·ª≠i l·ªùi m·ªùi';
              pendingBtn.disabled = true;
              actions.appendChild(pendingBtn);
            } else if (user.relationship === 'received_request') {
              const acceptBtn = document.createElement('button');
              acceptBtn.textContent = 'Ch·∫•p nh·∫≠n';
              acceptBtn.onclick = () => acceptFriendRequest(user.request_id);
              
              const rejectBtn = document.createElement('button');
              rejectBtn.textContent = 'T·ª´ ch·ªëi';
              rejectBtn.onclick = () => rejectFriendRequest(user.request_id);
              
              actions.appendChild(acceptBtn);
              actions.appendChild(rejectBtn);
            } else {
              const addBtn = document.createElement('button');
              addBtn.textContent = 'K·∫øt b·∫°n';
              addBtn.onclick = () => sendFriendRequest(user.id);
              actions.appendChild(addBtn);
            }
            
            li.appendChild(userInfo);
            li.appendChild(actions);
            
            searchResults.appendChild(li);
          });
          
          // Hi·ªÉn th·ªã tab k·∫øt qu·∫£ t√¨m ki·∫øm
          showTab('searchTab');
        } else {
          console.error('L·ªói t√¨m ki·∫øm ng∆∞·ªùi d√πng:', data.message);
          alert('L·ªói t√¨m ki·∫øm ng∆∞·ªùi d√πng: ' + data.message);
        }
      } catch (error) {
        console.error('L·ªói t√¨m ki·∫øm ng∆∞·ªùi d√πng:', error);
        alert('L·ªói t√¨m ki·∫øm ng∆∞·ªùi d√πng');
      }
    }
    
    // G·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n
    async function sendFriendRequest(receiverId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y');
          return;
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω
        const userItem = document.querySelector(`.user-item[data-id="${receiverId}"]`);
        if (userItem) {
          const addBtn = userItem.querySelector('button');
          if (addBtn) {
            addBtn.disabled = true;
            addBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
          }
        }

        const response = await fetch('http://localhost:5000/api/friends/request', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ receiverId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message || 'ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n th√†nh c√¥ng');
          
          // N·∫øu t·ª± ƒë·ªông ch·∫•p nh·∫≠n (ng∆∞·ªùi nh·∫≠n ƒë√£ g·ª≠i l·ªùi m·ªùi cho m√¨nh tr∆∞·ªõc ƒë√≥)
          if (data.autoAccepted) {
            loadFriends();
          } else {
            loadFriendRequests();
          }
          
          // C·∫≠p nh·∫≠t l·∫°i k·∫øt qu·∫£ t√¨m ki·∫øm
          searchUsers();
        } else {
          console.error('L·ªói g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n:', data.message);
          alert('L·ªói g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n: ' + (data.message || 'Kh√¥ng x√°c ƒë·ªãnh'));
          
          // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
          if (userItem) {
            const addBtn = userItem.querySelector('button');
            if (addBtn) {
              addBtn.disabled = false;
              addBtn.textContent = 'K·∫øt b·∫°n';
            }
          }
        }
      } catch (error) {
        console.error('L·ªói g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n:', error);
        alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i sau.');
        
        // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
        const userItem = document.querySelector(`.user-item[data-id="${receiverId}"]`);
        if (userItem) {
          const addBtn = userItem.querySelector('button');
          if (addBtn) {
            addBtn.disabled = false;
            addBtn.textContent = 'K·∫øt b·∫°n';
          }
        }
      }
    }
    
    // X√≥a b·∫°n b√®
    async function removeFriend(friendId) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi n√†y kh·ªèi danh s√°ch b·∫°n b√®?')) {
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/${friendId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          loadFriends();
        } else {
          alert('L·ªói: ' + data.message);
        }
      } catch (error) {
        console.error('L·ªói x√≥a b·∫°n b√®:', error);
        alert('L·ªói x√≥a b·∫°n b√®');
      }
    }
    
    // Ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n
    async function acceptFriendRequest(requestId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/request/${requestId}/accept`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          loadFriends();
          loadFriendRequests();
        } else {
          alert('L·ªói: ' + data.message);
        }
      } catch (error) {
        console.error('L·ªói ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n:', error);
        alert('L·ªói ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n');
      }
    }
    
    // T·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n
    async function rejectFriendRequest(requestId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/request/${requestId}/reject`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          loadFriendRequests();
        } else {
          alert('L·ªói: ' + data.message);
        }
      } catch (error) {
        console.error('L·ªói t·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n:', error);
        alert('L·ªói t·ª´ ch·ªëi l·ªùi m·ªùi k·∫øt b·∫°n');
      }
    }
    
    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi t·∫£i trang
    checkAuth();
    
    // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
    function showTab(tabId) {
      // ·∫®n t·∫•t c·∫£ c√°c tab
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // B·ªè active t·∫•t c·∫£ c√°c n√∫t tab
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
      document.getElementById(tabId).classList.add('active');
      
      // Active n√∫t tab t∆∞∆°ng ·ª©ng
      Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
        btn.getAttribute('onclick').includes(tabId)
      ).classList.add('active');
    }
  </script>
</body>
</html>