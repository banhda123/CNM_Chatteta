<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zalo Clone Chat</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .user-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 5px;
    }

    .status-online {
      background-color: #44b700;
    }

    .status-offline {
      background-color: #bdbdbd;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background: #f0f2f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    #auth {
      max-width: 400px;
      margin: 50px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    button {
      background: #0084ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0073e6;
    }

    #chat {
      display: none;
      height: calc(100vh - 40px);
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
    }

    .chat-header {
      padding: 15px;
      background: #0084ff;
      color: white;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .messages-container {
      height: calc(100% - 130px);
      overflow-y: auto;
      padding: 20px;
    }

    #messages {
      list-style: none;
    }

    .message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 15px;
    max-width: 70%;
    clear: both;
    position: relative;
  }

  .message.sent {
    float: right;
    background-color: #0084ff;
    color: white;
    margin-left: 30%;
    border-bottom-right-radius: 5px;
  }

  .message.received {
    float: left;
    background-color: #e4e6eb;
    color: black;
    margin-right: 30%;
    border-bottom-left-radius: 5px;
  }

  .message-sender {
    font-size: 12px;
    margin-bottom: 4px;
    opacity: 0.8;
  }

  .message-content {
    font-size: 14px;
    word-wrap: break-word;
  }

  .message-time {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 4px;
    text-align: right;
  }

  .messages {
    list-style: none;
    padding: 0;
  }

  .clearfix::after {
    content: "";
    clear: both;
    display: table;
  }
    .chat-input {
      padding: 15px;
      background: #f0f2f5;
      border-radius: 0 0 8px 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-input input {
      flex: 1;
    }

    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    
    .message-image {
      max-width: 300px;
      max-height: 300px;
      border-radius: 10px;
      margin-top: 5px;
      object-fit: contain;
    }
    
    .emoji-picker {
      position: absolute;
      bottom: 70px;
      right: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 10px;
      display: none;
      z-index: 100;
      width: 250px;
      height: 200px;
      overflow-y: auto;
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .emoji-item {
      font-size: 24px;
      cursor: pointer;
      text-align: center;
      padding: 5px;
      border-radius: 4px;
    }
    
    .emoji-item:hover {
      background-color: #f0f2f5;
    }
    
    .attachment-btn, .emoji-btn {
      background: none;
      border: none;
      color: #0084ff;
      font-size: 20px;
      cursor: pointer;
      padding: 5px 10px;
    }
    
    .file-input {
      display: none;
    }
    
    /* Styles cho sidebar và tính năng bạn bè */
    .sidebar {
      width: 300px;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      background-color: #f5f7fa;
    }
    
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 15px;
      background: #0084ff;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .search-container {
      padding: 10px;
      display: flex;
      gap: 5px;
    }
    
    .search-container input {
      flex: 1;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 10px;
      cursor: pointer;
      color: #555;
    }
    
    .tab-btn.active {
      border-bottom: 2px solid #0084ff;
      color: #0084ff;
    }
    
    .tab-content {
      display: none;
      padding: 10px;
      flex: 1;
      overflow-y: auto;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .user-list {
      list-style: none;
      padding: 0;
    }
    
    .user-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #555;
    }
    
    .user-actions {
      display: flex;
      gap: 5px;
    }
    
    .user-actions button {
      padding: 5px 10px;
      font-size: 12px;
    }
    
    .notification-badge {
      background-color: #ff3b30;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 5px;
    }
    
    .loading-message, .empty-message, .error-message {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      color: #666;
      font-style: italic;
    }
    .error-message {
      color: #e74c3c;
    }
    .date-separator {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      color: #666;
      font-size: 12px;
      position: relative;
    }
    .date-separator:before, .date-separator:after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30%;
      height: 1px;
      background-color: #ddd;
    }
    .date-separator:before {
      left: 0;
    }
    .date-separator:after {
      right: 0;
    }
    .message-sender {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
      font-weight: bold;
    }
    .sent .message-sender {
      color: #3498db;
    }
    .received .message-sender {
      color: #2ecc71;
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .user-info .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }
    .header-actions {
        display: flex;
        gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="auth">
      <div id="loginForm">
        <h2>Đăng nhập</h2>
        <div class="form-group">
          <input id="username" placeholder="Tên đăng nhập" />
          <input id="password" type="password" placeholder="Mật khẩu" />
          <button onclick="login()">Đăng nhập</button>
        </div>
      </div>
      
      <div id="registerForm">
        <h2>Đăng ký</h2>
        <div class="form-group">
          <input id="regUsername" placeholder="Tên đăng nhập" />
          <input id="regPassword" type="password" placeholder="Mật khẩu" />
          <input id="regFullname" placeholder="Họ tên" />
          <button onclick="register()">Đăng ký</button>
        </div>
      </div>
    </div>

    <div id="chat">
      <!-- Sidebar cho danh sách bạn bè và lời mời kết bạn -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div>
            <span class="user-status" id="userStatus"></span>
            <span id="userInfo"></span>
          </div>
          <button onclick="logout()">Đăng xuất</button>
        </div>
        
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Tìm kiếm người dùng..." />
          <button onclick="searchUsers()">Tìm</button>
        </div>
        
        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('friendsTab')">Bạn bè</button>
          <button class="tab-btn" onclick="showTab('requestsTab')">Lời mời</button>
          <button class="tab-btn" onclick="showTab('searchTab')">Kết quả</button>
        </div>
        
        <div id="friendsTab" class="tab-content active">
          <h3>Danh sách bạn bè</h3>
          <ul id="friendsList" class="user-list"></ul>
        </div>
        
        <div id="requestsTab" class="tab-content">
          <h3>Lời mời kết bạn</h3>
          <ul id="requestsList" class="user-list"></ul>
        </div>
        
        <div id="searchTab" class="tab-content">
          <h3>Kết quả tìm kiếm</h3>
          <ul id="searchResults" class="user-list"></ul>
        </div>
      </div>
      
      <!-- Khu vực chat chính -->
      <div class="chat-main">
        <div class="header">
            <div class="user-info">
                <img id="userAvatar" src="" alt="Avatar" class="avatar">
                <span id="username"></span>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.location.href='/profile'">Hồ sơ</button>
                <button class="btn btn-danger" onclick="logout()">Đăng xuất</button>
            </div>
        </div>
        <div class="chat-header">
          <h2 id="chatHeader">Chat</h2>
        </div>
        
        <div class="messages-container">
          <ul id="messages"></ul>
        </div>
        
        <div class="chat-input">
          <button class="emoji-btn" onclick="toggleEmojiPicker()">😊</button>
          <label for="fileInput" class="attachment-btn">📎</label>
          <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)" />
          <input id="messageInput" placeholder="Nhập tin nhắn..." onkeypress="handleKeyPress(event)"/>
          <button onclick="sendMessage()">Gửi</button>
          
          <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-grid" id="emojiGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Lấy token từ localStorage
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/';
    }

    // Load thông tin người dùng
    async function loadUserInfo() {
        try {
            const response = await fetch('/api/users/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('username').textContent = data.user.username;
                if (data.user.avatar) {
                    document.getElementById('userAvatar').src = data.user.avatar;
                }
            }
        } catch (error) {
            console.error('Lỗi khi tải thông tin người dùng:', error);
        }
    }

    // Xử lý đăng xuất
    function logout() {
        localStorage.removeItem('token');
        window.location.href = '/';
    }

    // Load thông tin khi trang tải xong
    loadUserInfo();

    // Kiểm tra đã đăng nhập chưa
    function checkAuth() {
      const token = localStorage.getItem('token');
      if (token) {
        document.getElementById('auth').style.display = 'none';
        document.getElementById('chat').style.display = 'flex';
        document.getElementById('userInfo').textContent = localStorage.getItem('username') || 'Người dùng';
        connectSocket();
        loadFriends();
        loadFriendRequests();
      } else {
        document.getElementById('auth').style.display = 'block';
        document.getElementById('chat').style.display = 'none';
      }
    }

    // Kết nối Socket.IO
    function connectSocket() {
      const token = localStorage.getItem('token');
      if (!token) return;

      // Nếu đã có socket, ngắt kết nối trước khi tạo mới
      if (window.socket) {
        console.log('Ngắt kết nối socket cũ trước khi tạo mới');
        window.socket.disconnect();
      }

      const socket = window.socket = io('http://localhost:5000', {
        auth: { token },
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        timeout: 10000 // Tăng timeout lên 10 giây
      });

      // Lắng nghe tin nhắn cũ
      socket.on('load-messages', (messages) => {
        console.log('Nhận tin nhắn cũ:', messages);
        const messagesList = document.getElementById('messages');
        messagesList.innerHTML = ''; // Xóa tin nhắn cũ
        
        // Xóa thông báo đang tải nếu có
        document.querySelector('.loading-message')?.remove();
        
        if (!messages) {
          console.error('Không nhận được dữ liệu tin nhắn');
          const errorMessage = document.createElement('li');
          errorMessage.className = 'error-message';
          errorMessage.textContent = 'Không thể tải tin nhắn. Vui lòng thử lại sau.';
          messagesList.appendChild(errorMessage);
          return;
        }
        
        if (Array.isArray(messages)) {
          if (messages.length === 0) {
            console.log('Không có tin nhắn cũ');
            const emptyMessage = document.createElement('li');
            emptyMessage.className = 'empty-message';
            emptyMessage.textContent = 'Chưa có tin nhắn nào. Hãy bắt đầu cuộc trò chuyện!';
            messagesList.appendChild(emptyMessage);
          } else {
            console.log(`Hiển thị ${messages.length} tin nhắn cũ`);
            
            // Thêm phân tách ngày nếu cần
            let currentDate = null;
            
            messages.forEach((message, index) => {
              console.log(`Tin nhắn ${index + 1}:`, message);
              
              // Kiểm tra và thêm phân tách ngày nếu cần
              if (message.created_at) {
                const messageDate = new Date(message.created_at).toLocaleDateString();
                if (messageDate !== currentDate) {
                  currentDate = messageDate;
                  const dateDiv = document.createElement('div');
                  dateDiv.className = 'date-separator';
                  dateDiv.textContent = currentDate;
                  messagesList.appendChild(dateDiv);
                }
              }
              
              // Thêm tin nhắn vào giao diện
              addMessage(message);
            });
          }
          
          // Cuộn xuống tin nhắn mới nhất
          setTimeout(() => {
            const container = document.querySelector('.messages-container');
            if (container) {
              container.scrollTop = container.scrollHeight;
            }
          }, 100);
        } else {
          console.error('Dữ liệu tin nhắn không phải là mảng:', messages);
          const errorMessage = document.createElement('li');
          errorMessage.className = 'error-message';
          errorMessage.textContent = 'Định dạng tin nhắn không hợp lệ.';
          messagesList.appendChild(errorMessage);
        }
      });

      // Lắng nghe tin nhắn mới
      socket.on('new-message', (message) => {
        console.log('Nhận tin nhắn mới:', message);
        
        // Xóa thông báo "Chưa có tin nhắn nào" nếu có
        const emptyMessage = document.querySelector('.empty-message');
        if (emptyMessage) {
          emptyMessage.remove();
        }
        
        addMessage(message);
        
        // Cuộn xuống tin nhắn mới nhất
        setTimeout(() => {
          const container = document.querySelector('.messages-container');
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        }, 100);
      });

      socket.on('connect', () => {
        console.log('Đã kết nối socket');
        socket.emit('update-status', { status: 'online' });
        
        // Nếu đã có người nhận, tham gia vào cuộc trò chuyện với họ
        if (currentRecipient.id) {
          console.log('Tham gia cuộc trò chuyện với:', currentRecipient.id);
          socket.emit('join-conversation', currentRecipient.id);
        }
      });

      socket.on('disconnect', () => {
        console.log('Mất kết nối socket');
      });

      socket.on('status-update', (data) => {
        console.log('Cập nhật trạng thái:', data);
        const statusElement = document.getElementById('userStatus');
        if (statusElement) {
          statusElement.className = `user-status status-${data.status}`;
        }
      });
      
      // Thêm sự kiện lắng nghe lỗi
      socket.on('connect_error', (error) => {
        console.error('Lỗi kết nối socket:', error);
        // Hiển thị thông báo lỗi nếu đang trong cuộc trò chuyện
        if (currentRecipient.id) {
          const loadingMessage = document.querySelector('.loading-message');
          if (loadingMessage) {
            loadingMessage.remove();
            
            const errorMessage = document.createElement('li');
            errorMessage.className = 'error-message';
            errorMessage.textContent = 'Lỗi kết nối đến server. Vui lòng thử lại sau.';
            document.getElementById('messages').appendChild(errorMessage);
          }
        }
      });
      
      socket.on('error', (error) => {
        console.error('Lỗi socket:', error);
      });
      
      // Lắng nghe phản hồi từ sự kiện join-conversation
      socket.on('joined-conversation', (data) => {
        console.log('Đã tham gia cuộc trò chuyện:', data);
      });
    }

    // Thêm tin nhắn vào giao diện
    function addMessage(message, isSent = null) {
      try {
        console.log('Thêm tin nhắn vào giao diện:', message);
        
        if (!message || !message.content) {
          console.error('Tin nhắn không hợp lệ:', message);
          return;
        }
        
        const currentUserId = localStorage.getItem('userId');
        console.log('ID người dùng hiện tại:', currentUserId);
        console.log('ID người gửi tin nhắn:', message.sender_id);
        
        // Nếu isSent không được chỉ định, tính toán dựa trên sender_id
        if (isSent === null && message.sender_id) {
          isSent = message.sender_id.toString() === currentUserId;
        }
        
        console.log('Tin nhắn này do người dùng hiện tại gửi?', isSent);
        
        const messages = document.getElementById('messages');
        const li = document.createElement('li');
        li.className = `message ${isSent ? 'sent' : 'received'} clearfix`;
        
        // Thêm thông tin người gửi cho tất cả tin nhắn
        const senderDiv = document.createElement('div');
        senderDiv.className = 'message-sender';
        
        if (isSent) {
          senderDiv.textContent = 'Bạn';
          senderDiv.style.textAlign = 'right';
        } else {
          senderDiv.textContent = message.sender_name || currentRecipient.name || 'Người dùng';
        }
        
        li.appendChild(senderDiv);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        // Xử lý hiển thị tin nhắn theo loại
        if (message.type === 'image') {
          // Hiển thị ảnh
          const img = document.createElement('img');
          img.src = message.content;
          img.className = 'message-image';
          img.alt = 'Hình ảnh';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/200x150?text=Lỗi+tải+ảnh';
          };
          contentDiv.appendChild(img);
        } else if (message.type === 'emoji') {
          // Hiển thị emoji
          contentDiv.textContent = message.content;
          contentDiv.style.fontSize = '24px';
        } else {
          // Hiển thị tin nhắn văn bản thông thường
          contentDiv.textContent = message.content;
        }
        
        li.appendChild(contentDiv);
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        
        // Xử lý trường hợp không có created_at
        if (message.created_at) {
          const messageTime = new Date(message.created_at);
          timeDiv.textContent = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else {
          timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        li.appendChild(timeDiv);
        
        // Thêm ID tin nhắn để dễ debug
        if (message.id) {
          li.setAttribute('data-message-id', message.id);
        }
        
        messages.appendChild(li);
      } catch (error) {
        console.error('Lỗi hiển thị tin nhắn:', error, message);
      }
    }

    // Biến lưu trữ file ảnh đã chọn
    let selectedFile = null;
    
    // Biến lưu trữ thông tin người nhận tin nhắn hiện tại
    let currentRecipient = {
      id: null,
      name: null
    };
    
    // Gửi tin nhắn
    function sendMessage() {
      try {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        
        // Kiểm tra xem đã chọn người nhận chưa
        if (!currentRecipient.id) {
          alert('Vui lòng chọn một người bạn để nhắn tin');
          return;
        }
        
        // Đảm bảo ID người nhận là số
        const recipientId = parseInt(currentRecipient.id, 10);
        if (isNaN(recipientId)) {
          console.error('ID người nhận không hợp lệ:', currentRecipient.id);
          return;
        }
        
        // Nếu có file ảnh được chọn, ưu tiên gửi ảnh
        if (selectedFile && window.socket) {
          uploadAndSendImage(selectedFile);
          selectedFile = null;
          return;
        }
        
        // Nếu không có ảnh, gửi tin nhắn văn bản
        if (message && window.socket) {
          // Tạo đối tượng tin nhắn tạm thời để hiển thị ngay
          const tempMessage = {
            content: message,
            type: 'text',
            sender_id: localStorage.getItem('userId'),
            sender_name: localStorage.getItem('username'),
            created_at: new Date().toISOString()
          };
          
          // Hiển thị tin nhắn ngay lập tức trên giao diện
          addMessage(tempMessage, true);
          
          // Gửi tin nhắn đến server
          window.socket.emit('send-message', {
            conversationId: recipientId,
            content: message,
            type: 'text'
          });
          
          console.log('Đã gửi tin nhắn:', {
            conversationId: recipientId,
            content: message,
            type: 'text'
          });
          
          // Xóa nội dung input
          input.value = '';
        }
      } catch (error) {
        console.error('Lỗi khi gửi tin nhắn:', error);
      }
    }
    
    // Xử lý khi chọn file
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Kiểm tra xem file có phải là ảnh không
      if (!file.type.startsWith('image/')) {
        alert('Vui lòng chọn file ảnh');
        return;
      }
      
      // Lưu file đã chọn
      selectedFile = file;
      
      // Thông báo cho người dùng biết đã chọn ảnh
      const input = document.getElementById('messageInput');
      input.placeholder = `Đã chọn ảnh: ${file.name}. Nhấn Gửi để gửi ảnh.`;
    }
    
    // Upload và gửi ảnh
    async function uploadAndSendImage(file) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/upload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success && data.url) {
          // Gửi tin nhắn với đường dẫn ảnh
          window.socket.emit('send-message', {
            conversationId: currentRecipient.id,
            content: data.url,
            type: 'image'
          });
          
          // Reset placeholder
          const input = document.getElementById('messageInput');
          input.placeholder = 'Nhập tin nhắn...';
          
          // Reset file input
          document.getElementById('fileInput').value = '';
        } else {
          alert('Lỗi khi tải lên ảnh: ' + (data.message || 'Không xác định'));
        }
      } catch (error) {
        console.error('Lỗi khi tải lên ảnh:', error);
        alert('Lỗi kết nối đến server');
      }
    }
    
    // Hiển thị/ẩn emoji picker
    function toggleEmojiPicker() {
      const emojiPicker = document.getElementById('emojiPicker');
      if (emojiPicker.style.display === 'block') {
        emojiPicker.style.display = 'none';
      } else {
        emojiPicker.style.display = 'block';
        loadEmojis();
      }
    }
    
    // Load danh sách emoji
    function loadEmojis() {
      const emojiGrid = document.getElementById('emojiGrid');
      if (emojiGrid.children.length > 0) return; // Đã load rồi
      
      // Danh sách emoji phổ biến
      const emojis = [
        '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
        '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
        '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
        '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖',
        '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯',
        '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '💔', '❣️', '💕',
        '💞', '💓', '💗', '💖', '💘', '💝', '💟', '👍', '👎', '👌'
      ];
      
      // Tạo các phần tử emoji
      emojis.forEach(emoji => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.textContent = emoji;
        emojiItem.onclick = () => sendEmoji(emoji);
        emojiGrid.appendChild(emojiItem);
      });
    }
    
    // Gửi emoji
    function sendEmoji(emoji) {
      if (window.socket) {
        // Kiểm tra xem đã chọn người nhận chưa
        if (!currentRecipient.id) {
          alert('Vui lòng chọn một người bạn để nhắn tin');
          return;
        }
        
        // Tạo đối tượng tin nhắn tạm thời để hiển thị ngay
        const tempMessage = {
          content: emoji,
          type: 'emoji',
          sender_id: localStorage.getItem('userId'),
          sender_name: localStorage.getItem('username'),
          created_at: new Date().toISOString()
        };
        
        // Hiển thị emoji ngay lập tức trên giao diện
        addMessage(tempMessage, true);
        
        // Gửi emoji đến server
        window.socket.emit('send-message', {
          conversationId: currentRecipient.id,
          content: emoji,
          type: 'emoji'
        });
        
        console.log('Đã gửi emoji:', {
          conversationId: currentRecipient.id,
          content: emoji,
          type: 'emoji'
        });
        
        // Ẩn emoji picker
        document.getElementById('emojiPicker').style.display = 'none';
      }
    }

    // Xử lý phím Enter
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Đăng nhập
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('http://localhost:5000/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('username', data.user.username);
          localStorage.setItem('userId', data.user.id);
          alert('Đăng nhập thành công!');
          checkAuth();
        } else {
          alert('Đăng nhập thất bại: ' + data.message);
        }
      } catch (error) {
        console.error('Lỗi đăng nhập:', error);
        alert('Lỗi kết nối đến server');
      }
    }

    // Đăng ký
    async function register() {
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const fullname = document.getElementById('regFullname').value;
      
      if (!username || !password || !fullname) {
        alert('Vui lòng điền đầy đủ thông tin đăng ký');
        return;
      }
      
      try {
        const response = await fetch('http://localhost:5000/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password, fullname })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('Đăng ký thành công! Vui lòng đăng nhập.');
          document.getElementById('username').value = username;
        } else {
          alert('Đăng ký thất bại: ' + (data.message || 'Lỗi không xác định'));
        }
      } catch (error) {
        console.error('Lỗi đăng ký:', error);
        alert('Lỗi kết nối đến server');
      }
    }

    // Bắt đầu cuộc trò chuyện với bạn bè
    function startChat(friendId, friendName) {
      try {
        console.log('Bắt đầu cuộc trò chuyện với bạn bè:', { friendId, friendName });
        
        // Đảm bảo friendId là số
        friendId = parseInt(friendId, 10);
        if (isNaN(friendId)) {
          console.error('ID bạn bè không hợp lệ:', friendId);
          return;
        }
        
        // Lưu thông tin người nhận hiện tại
        currentRecipient.id = friendId;
        
        // Nếu không có tên, lấy từ danh sách bạn bè
        if (!friendName) {
          const friendsList = document.querySelectorAll('#friendsList .user-item');
          for (const item of friendsList) {
            const id = item.getAttribute('data-id');
            if (id === friendId.toString()) {
              friendName = item.querySelector('.user-info div:first-child').textContent;
              break;
            }
          }
        }
        
        currentRecipient.name = friendName || 'Người dùng';
        console.log('Thông tin người nhận hiện tại:', currentRecipient);
        
        // Cập nhật tiêu đề chat
        document.querySelector('.chat-header h2').textContent = `Chat với ${currentRecipient.name}`;
        
        // Xóa tin nhắn cũ trong khung chat
        document.getElementById('messages').innerHTML = '';
        
        // Hiển thị thông báo đang tải
        const loadingMessage = document.createElement('li');
        loadingMessage.className = 'loading-message';
        loadingMessage.textContent = 'Đang tải tin nhắn...';
        document.getElementById('messages').appendChild(loadingMessage);
        
        // Hiển thị khung chat nếu đang ẩn
        document.querySelector('.chat-container').style.display = 'flex';
        
        // Tham gia vào cuộc trò chuyện
        if (window.socket && window.socket.connected) {
          console.log('Socket đã kết nối, tham gia cuộc trò chuyện với:', friendId);
          window.socket.emit('join-conversation', friendId);
        } else {
          console.log('Socket chưa kết nối, thử kết nối lại');
          // Thử kết nối lại
          connectSocket();
          
          // Đặt timeout dài hơn để đảm bảo socket có đủ thời gian kết nối
          setTimeout(() => {
            if (window.socket && window.socket.connected) {
              console.log('Đã kết nối lại socket, tham gia cuộc trò chuyện với:', friendId);
              window.socket.emit('join-conversation', friendId);
            } else {
              console.error('Không thể kết nối socket sau khi thử lại');
              // Xóa thông báo đang tải
              document.querySelector('.loading-message')?.remove();
              
              // Hiển thị thông báo lỗi
              const errorMessage = document.createElement('li');
              errorMessage.className = 'error-message';
              errorMessage.textContent = 'Không thể kết nối đến server. Vui lòng thử lại sau.';
              document.getElementById('messages').appendChild(errorMessage);
            }
          }, 3000); // Tăng thời gian chờ lên 3 giây
        }
        
        // Focus vào ô nhập tin nhắn
        document.getElementById('messageInput').focus();
      } catch (error) {
        console.error('Lỗi khi bắt đầu cuộc trò chuyện:', error);
      }
    }
    
    // Thêm xử lý tìm kiếm khi nhấn Enter
    document.getElementById('searchInput').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        searchUsers();
      }
    });
    
    // Lấy danh sách bạn bè
    async function loadFriends() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/friends/list', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const friendsList = document.getElementById('friendsList');
          friendsList.innerHTML = '';
          
          if (data.friends.length === 0) {
            friendsList.innerHTML = '<li class="user-item">Bạn chưa có bạn bè nào</li>';
            return;
          }
          
          // Sử dụng Set để loại bỏ trùng lặp dựa trên ID
          const uniqueFriends = Array.from(
            new Map(data.friends.map(friend => [friend.id, friend])).values()
          );
          
          console.log('Danh sách bạn bè (đã loại bỏ trùng lặp):', uniqueFriends);
          
          uniqueFriends.forEach(friend => {
            const li = document.createElement('li');
            li.className = 'user-item';
            li.setAttribute('data-id', friend.id);
            
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            avatar.textContent = friend.fullname.charAt(0).toUpperCase();
            
            const nameStatus = document.createElement('div');
            const name = document.createElement('div');
            name.textContent = friend.fullname;
            
            const status = document.createElement('div');
            status.innerHTML = `<span class="user-status status-${friend.status || 'offline'}"></span> ${friend.status || 'offline'}`;
            
            nameStatus.appendChild(name);
            nameStatus.appendChild(status);
            
            userInfo.appendChild(avatar);
            userInfo.appendChild(nameStatus);
            
            const actions = document.createElement('div');
            actions.className = 'user-actions';
            
            const chatBtn = document.createElement('button');
            chatBtn.textContent = 'Nhắn tin';
            chatBtn.onclick = () => startChat(friend.id, friend.fullname);
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Xóa bạn';
            removeBtn.onclick = () => removeFriend(friend.id);
            
            actions.appendChild(chatBtn);
            actions.appendChild(removeBtn);
            
            li.appendChild(userInfo);
            li.appendChild(actions);
            
            friendsList.appendChild(li);
          });
        } else {
          console.error('Lỗi lấy danh sách bạn bè:', data.message);
        }
      } catch (error) {
        console.error('Lỗi lấy danh sách bạn bè:', error);
      }
    }
    
    // Lấy danh sách lời mời kết bạn
    async function loadFriendRequests() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('http://localhost:5000/api/friends/requests', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const requestsList = document.getElementById('requestsList');
          requestsList.innerHTML = '';
          
          // Hiển thị lời mời đã nhận
          if (data.received.length > 0) {
            const receivedHeader = document.createElement('li');
            receivedHeader.className = 'request-header';
            receivedHeader.textContent = 'Lời mời đã nhận';
            requestsList.appendChild(receivedHeader);
            
            data.received.forEach(request => {
              const li = document.createElement('li');
              li.className = 'user-item';
              
              const userInfo = document.createElement('div');
              userInfo.className = 'user-info';
              
              const avatar = document.createElement('div');
              avatar.className = 'user-avatar';
              avatar.textContent = request.fullname.charAt(0).toUpperCase();
              
              const nameTime = document.createElement('div');
              const name = document.createElement('div');
              name.textContent = request.fullname;
              
              const time = document.createElement('div');
              time.className = 'request-time';
              time.textContent = new Date(request.created_at).toLocaleString();
              
              nameTime.appendChild(name);
              nameTime.appendChild(time);
              
              userInfo.appendChild(avatar);
              userInfo.appendChild(nameTime);
              
              const actions = document.createElement('div');
              actions.className = 'user-actions';
              
              const acceptBtn = document.createElement('button');
              acceptBtn.textContent = 'Chấp nhận';
              acceptBtn.onclick = () => acceptFriendRequest(request.id);
              
              const rejectBtn = document.createElement('button');
              rejectBtn.textContent = 'Từ chối';
              rejectBtn.onclick = () => rejectFriendRequest(request.id);
              
              actions.appendChild(acceptBtn);
              actions.appendChild(rejectBtn);
              
              li.appendChild(userInfo);
              li.appendChild(actions);
              
              requestsList.appendChild(li);
            });
          }
          
          // Hiển thị lời mời đã gửi
          if (data.sent.length > 0) {
            const sentHeader = document.createElement('li');
            sentHeader.className = 'request-header';
            sentHeader.textContent = 'Lời mời đã gửi';
            requestsList.appendChild(sentHeader);
            
            data.sent.forEach(request => {
              const li = document.createElement('li');
              li.className = 'user-item';
              
              const userInfo = document.createElement('div');
              userInfo.className = 'user-info';
              
              const avatar = document.createElement('div');
              avatar.className = 'user-avatar';
              avatar.textContent = request.fullname.charAt(0).toUpperCase();
              
              const nameTime = document.createElement('div');
              const name = document.createElement('div');
              name.textContent = request.fullname;
              
              const time = document.createElement('div');
              time.className = 'request-time';
              time.textContent = new Date(request.created_at).toLocaleString();
              
              nameTime.appendChild(name);
              nameTime.appendChild(time);
              
              userInfo.appendChild(avatar);
              userInfo.appendChild(nameTime);
              
              const status = document.createElement('div');
              status.className = 'request-status';
              status.textContent = 'Đang chờ';
              
              li.appendChild(userInfo);
              li.appendChild(status);
              
              requestsList.appendChild(li);
            });
          }
          
          if (data.received.length === 0 && data.sent.length === 0) {
            requestsList.innerHTML = '<li class="user-item">Không có lời mời kết bạn nào</li>';
          }
        } else {
          console.error('Lỗi lấy danh sách lời mời kết bạn:', data.message);
        }
      } catch (error) {
        console.error('Lỗi lấy danh sách lời mời kết bạn:', error);
      }
    }
    
    // Tìm kiếm người dùng
    async function searchUsers() {
      try {
        const keyword = document.getElementById('searchInput').value.trim();
        
        if (keyword.length < 2) {
          alert('Vui lòng nhập ít nhất 2 ký tự để tìm kiếm');
          return;
        }
        
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/search?keyword=${encodeURIComponent(keyword)}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          const searchResults = document.getElementById('searchResults');
          searchResults.innerHTML = '';
          
          if (data.users.length === 0) {
            searchResults.innerHTML = '<li class="user-item">Không tìm thấy người dùng nào</li>';
            return;
          }
          
          data.users.forEach(user => {
            const li = document.createElement('li');
            li.className = 'user-item';
            li.setAttribute('data-id', user.id);
            
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            
            const avatar = document.createElement('div');
            avatar.className = 'user-avatar';
            avatar.textContent = user.fullname.charAt(0).toUpperCase();
            
            const nameStatus = document.createElement('div');
            const name = document.createElement('div');
            name.textContent = user.fullname;
            
            const status = document.createElement('div');
            status.innerHTML = `<span class="user-status status-${user.status || 'offline'}"></span> ${user.status || 'offline'}`;
            
            nameStatus.appendChild(name);
            nameStatus.appendChild(status);
            
            userInfo.appendChild(avatar);
            userInfo.appendChild(nameStatus);
            
            const actions = document.createElement('div');
            actions.className = 'user-actions';
            
            // Hiển thị nút tương ứng với mối quan hệ
            if (user.relationship === 'friend') {
              const chatBtn = document.createElement('button');
              chatBtn.textContent = 'Nhắn tin';
              chatBtn.onclick = () => startChat(user.id, user.fullname);
              
              const removeBtn = document.createElement('button');
              removeBtn.textContent = 'Xóa bạn';
              removeBtn.onclick = () => removeFriend(user.id);
              
              actions.appendChild(chatBtn);
              actions.appendChild(removeBtn);
            } else if (user.relationship === 'sent_request') {
              const pendingBtn = document.createElement('button');
              pendingBtn.textContent = 'Đã gửi lời mời';
              pendingBtn.disabled = true;
              actions.appendChild(pendingBtn);
            } else if (user.relationship === 'received_request') {
              const acceptBtn = document.createElement('button');
              acceptBtn.textContent = 'Chấp nhận';
              acceptBtn.onclick = () => acceptFriendRequest(user.request_id);
              
              const rejectBtn = document.createElement('button');
              rejectBtn.textContent = 'Từ chối';
              rejectBtn.onclick = () => rejectFriendRequest(user.request_id);
              
              actions.appendChild(acceptBtn);
              actions.appendChild(rejectBtn);
            } else {
              const addBtn = document.createElement('button');
              addBtn.textContent = 'Kết bạn';
              addBtn.onclick = () => sendFriendRequest(user.id);
              actions.appendChild(addBtn);
            }
            
            li.appendChild(userInfo);
            li.appendChild(actions);
            
            searchResults.appendChild(li);
          });
          
          // Hiển thị tab kết quả tìm kiếm
          showTab('searchTab');
        } else {
          console.error('Lỗi tìm kiếm người dùng:', data.message);
          alert('Lỗi tìm kiếm người dùng: ' + data.message);
        }
      } catch (error) {
        console.error('Lỗi tìm kiếm người dùng:', error);
        alert('Lỗi tìm kiếm người dùng');
      }
    }
    
    // Gửi lời mời kết bạn
    async function sendFriendRequest(receiverId) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Bạn cần đăng nhập để thực hiện chức năng này');
          return;
        }

        // Hiển thị thông báo đang xử lý
        const userItem = document.querySelector(`.user-item[data-id="${receiverId}"]`);
        if (userItem) {
          const addBtn = userItem.querySelector('button');
          if (addBtn) {
            addBtn.disabled = true;
            addBtn.textContent = 'Đang xử lý...';
          }
        }

        const response = await fetch('http://localhost:5000/api/friends/request', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ receiverId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message || 'Đã gửi lời mời kết bạn thành công');
          
          // Nếu tự động chấp nhận (người nhận đã gửi lời mời cho mình trước đó)
          if (data.autoAccepted) {
            loadFriends();
          } else {
            loadFriendRequests();
          }
          
          // Cập nhật lại kết quả tìm kiếm
          searchUsers();
        } else {
          console.error('Lỗi gửi lời mời kết bạn:', data.message);
          alert('Lỗi gửi lời mời kết bạn: ' + (data.message || 'Không xác định'));
          
          // Khôi phục trạng thái nút
          if (userItem) {
            const addBtn = userItem.querySelector('button');
            if (addBtn) {
              addBtn.disabled = false;
              addBtn.textContent = 'Kết bạn';
            }
          }
        }
      } catch (error) {
        console.error('Lỗi gửi lời mời kết bạn:', error);
        alert('Lỗi kết nối đến server. Vui lòng thử lại sau.');
        
        // Khôi phục trạng thái nút
        const userItem = document.querySelector(`.user-item[data-id="${receiverId}"]`);
        if (userItem) {
          const addBtn = userItem.querySelector('button');
          if (addBtn) {
            addBtn.disabled = false;
            addBtn.textContent = 'Kết bạn';
          }
        }
      }
    }
    
    // Xóa bạn bè
    async function removeFriend(friendId) {
      if (!confirm('Bạn có chắc chắn muốn xóa người này khỏi danh sách bạn bè?')) {
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/${friendId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          loadFriends();
        } else {
          alert('Lỗi: ' + data.message);
        }
      } catch (error) {
        console.error('Lỗi xóa bạn bè:', error);
        alert('Lỗi xóa bạn bè');
      }
    }
    
    // Chấp nhận lời mời kết bạn
    async function acceptFriendRequest(requestId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/request/${requestId}/accept`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          loadFriends();
          loadFriendRequests();
        } else {
          alert('Lỗi: ' + data.message);
        }
      } catch (error) {
        console.error('Lỗi chấp nhận lời mời kết bạn:', error);
        alert('Lỗi chấp nhận lời mời kết bạn');
      }
    }
    
    // Từ chối lời mời kết bạn
    async function rejectFriendRequest(requestId) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:5000/api/friends/request/${requestId}/reject`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert(data.message);
          loadFriendRequests();
        } else {
          alert('Lỗi: ' + data.message);
        }
      } catch (error) {
        console.error('Lỗi từ chối lời mời kết bạn:', error);
        alert('Lỗi từ chối lời mời kết bạn');
      }
    }
    
    // Kiểm tra trạng thái đăng nhập khi tải trang
    checkAuth();
    
    // Hiển thị tab được chọn
    function showTab(tabId) {
      // Ẩn tất cả các tab
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Bỏ active tất cả các nút tab
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Hiển thị tab được chọn
      document.getElementById(tabId).classList.add('active');
      
      // Active nút tab tương ứng
      Array.from(document.querySelectorAll('.tab-btn')).find(btn => 
        btn.getAttribute('onclick').includes(tabId)
      ).classList.add('active');
    }
  </script>
</body>
</html>